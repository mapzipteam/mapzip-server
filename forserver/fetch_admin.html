<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    
    <link rel="stylesheet" href="admin_all.css">
    <style type="text/css">
    #old_fetch_contents{
        border: 1px solid #eee;
        background-color: #fff;
        padding: 5px;
        margin: 5px;
    }

    </style>
    <title>관리자페이지</title>
</head>
<body>
    <script type="text/javascript" src="admin_all.js"></script>
    <script type="text/javascript">
    isLogin();
    </script>
    <div class="full-frame">
        <div class="header-part">
            <h1>MapZip 관리자 페이지입니다</h1>
        </div>
        <div class="center-part">
            <?php include("nav_contents.html");?>
            <div class="contents-main">
                <h2>패치사항에 알려줄 내용을 적는 부분입니다.</h2>
                <label>현재 패치공지사항 : </label><br />
                <!--<textarea id="old_fetch_contents" cols="100" rows="15" readonly="readonly"></textarea>-->
                <div id="old_fetch_contents"></div>
                <form id="contact-form" action="fetch_admin.html" method="post" onsubmit="update_new()">
                    <label>새로운 패치사항 : </label><br />
                    <textarea name="new_fetch_contents" cols="100" rows="20"></textarea><br>
                    <label>새버전 : </label><input type="text" name="new_version" />
                    <input type="hidden" name="do" value="ok" />
                    
                    <input type="submit" value="submit" id="fetch_submit"/>
                </form>

            </div>
            
        </div>
    <script>
        function fill_old(old_contents) {
            var old_patch = document.getElementById("old_fetch_contents");
            old_patch.innerHTML = old_contents;
            
        }
        function update_new(){
            alert("새로운 공지사항을 반영하였습니다");
        }
        
    </script>
    <?php
    include("../fmysql.php");
    include("../mapzip-mysql-define.php");
    include("../mapzip-state-define.php");

    if(!$conn = connect_mysqli(MYSQL_IP,MAIN_DB,DB_PASSWORD,USE_DB)){
        echo "connnection error!\n";
        //$to_client['state']=DB_CONNECTION_ERROR;
        echo("<script>alert('DB 연결에 문제가 있습니다');</script>");
    }
    else{
        //echo "connect success!<br>";
    }

    
    if($_POST['do']=="ok"){
        
        //$result = str_replace('\r\n','\n',$_POST['new_fetch_contents']);
        $sql = "UPDATE ".UPDATE_TABLE." SET contents = '{$_POST['new_fetch_contents']}', version = {$_POST['new_version']} where id = 1";
        //echo "<script>fill_old();</script><br>";
        if(!$result = mysqli_query($conn,$sql)){
            echo "query fail...\n";
        //$to_client['state']=SQL_QUERY_ERROR;
        }
        $old_contents = "ID : "."1"."\r\n";
        $old_contents .= "버전 : ".$_POST['new_version']."\r\n";
        $old_contents .= "내용 : "."\r\n";
        $old_contents .= "{$_POST['new_fetch_contents']}"."\r\n";
        $old_contents = str_replace("\r\n","<br>",$old_contents);
        //$old_contents = nl2br($old_contents);
    }
    else{
        $sql = "SELECT * FROM ".UPDATE_TABLE;

        if(!$result = mysqli_query($conn,$sql)){
            echo "query fail...\n";
            //$to_client['state']=SQL_QUERY_ERROR;
        }
        while($row = mysqli_fetch_assoc($result)){
            $old_contents = "ID : ".$row['id']."\r\n";
            $old_contents .= "버전 : ".$row['version']."\r\n";
            $old_contents .= "내용 : "."\r\n";
            $old_contents .= "{$row['contents']}"."\r\n";
            $old_contents = str_replace("\r\n","<br>",$old_contents);
            //$old_contents = nl2br($old_contents);
            break;
        }
    }

    ?>
    <script type="text/javascript">
    fill_old("<?=$old_contents ?>");
    </script>
    
    <?php include("./foot-contents.html"); ?>

    </div>
    
</body>