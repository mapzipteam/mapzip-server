<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="loginstyle.css">
    <title>관리자페이지</title>
</head>
<body>
    
    <?php
    if($_POST['onlyfrom']!='ok'){
        echo('<script>location.replace("./errorPage.html");</script>');
    }
    ?>
   
<div class="center-part">
    <h1>MapZip 관리자 페이지입니다</h1>
    <h2>패치사항에 알려줄 내용을 적는 부분입니다.</h2>
    <label>현재 패치공지사항 : </label><br />
    <textarea id="old_fetch_contents" cols="100" rows="15" readonly="readonly"></textarea>
    <form id="contact-form" action="admin.html" method="post" onsubmit="update_new()">
        <label>새로운 패치사항 : </label><br />
        <textarea name="new_fetch_contents" cols="100" rows="20"></textarea><br>
        <label>새버전 : </label><input type="text" name="new_version" />
        <input type="hidden" name="do" value="ok" />
        <input type="hidden" name="onlyfrom" value="ok"/>
        <input type="submit" value="submit" id="fetch_submit"/>
    </form>
</div>
    <script>
        function fill_old(old_contents) {
            var old_patch = document.getElementById("old_fetch_contents");
            old_patch.value = old_contents;
            document.write("this is fill_old");
        }
        function update_new(){
            alert("새로운 공지사항을 반영하였습니다");
        }
        
    </script>
    <?php
    include("../fmysql.php");
    include("../mapzip-mysql-define.php");
    include("../mapzip-state-define.php");

    if(!$conn = connect_mysqli(MYSQL_IP,MAIN_DB,DB_PASSWORD,USE_DB)){
        echo "connnection error!\n";
        //$to_client['state']=DB_CONNECTION_ERROR;
    }
    else{
        echo "connect success!<br>";
    }

    
    if($_POST['do']=="ok"){
    	echo("new contents : ".$_POST['new_fetch_contents']." !<br>");
        $sql = "UPDATE ".UPDATE_TABLE." SET contents = '{$_POST['new_fetch_contents']}', version = {$_POST['new_version']} where id = 1";
    	//echo "<script>fill_old();</script><br>";
        if(!$result = mysqli_query($conn,$sql)){
            echo "query fail...\n";
        //$to_client['state']=SQL_QUERY_ERROR;
        }
        $old_contents = "ID : "."1".'\n';
        $old_contents .= "버전 : ".$_POST['new_version'].'\n';
        $old_contents .= "내용 : ".'\n'.$_POST['new_fetch_contents'].'\n';
    }
    else{
        $sql = "SELECT * FROM ".UPDATE_TABLE;

        if(!$result = mysqli_query($conn,$sql)){
            echo "query fail...\n";
            //$to_client['state']=SQL_QUERY_ERROR;
        }
        while($row = mysqli_fetch_assoc($result)){
            $old_contents = "ID : ".$row['id'].'\n';
            $old_contents .= "버전 : ".$row['version'].'\n';
            $old_contents .= "내용 : ".'\n'.$row['contents'].'\n';
            break;
        }
    }

    ?>
    <script type="text/javascript">
    fill_old("<?=$old_contents ?>");
    </script>
</body>